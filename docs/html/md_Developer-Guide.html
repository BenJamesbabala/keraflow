<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Keraflow: Developer-Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Keraflow
   </div>
   <div id="projectbrief">Deep Learning for Python.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_Developer-Guide.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Developer-Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#writing_customized_layer">Writing Customized Layer</a><ul><li class="level2"><a href="#implementing_layer_functions">Implementing Layer Functions</a></li>
<li class="level2"><a href="#layer_embedding">Layer Embedding</a></li>
</ul>
</li>
<li class="level1"><a href="#keraflow_mechanism">Keraflow mechanism</a><ul><li class="level2"><a href="#tensor_linkage_mechanism">Tensor Linkage Mechanism</a></li>
<li class="level2"><a href="#serialization_mechanism">Serialization Mechanism</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="writing_customized_layer"></a>
Writing Customized Layer</h1>
<p>In the following, we describe the basic and advanced issues about writing customized layer.</p>
<h2><a class="anchor" id="implementing_layer_functions"></a>
Implementing Layer Functions</h2>
<p>To make a customized layer works:</p>
<ol type="1">
<li>The layer class should inherit either <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html">Layer</a> (for single input layer) or <a class="el" href="classkeraflow_1_1layers_1_1base_1_1MultiInputLayer.html">MultiInputLayer</a> (for multiple input layer).</li>
<li>The layer's <code>__init__</code> should accept <code>**kwargs</code> and call <code>super(NewLayerClass, self).__init__(**kwargs)</code> to initialize <a class="el" href="md_Tutorials.html#layer_initialization">common arguments</a> of Layer.</li>
<li>The following functions should be implemented:</li>
</ol>
<ul>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#aaa1deaadb3e0ceb7f3bddbe569c01584">init_param(input_shape)</a>: Initialize and register the trainable parameters of the layer. If the layer contains no parameter, you could skip this function.</li>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#a5a5b42a33522e6d5cde6ee8e880ecd58">output(input_tensor)</a>: Transform input tensor (or a list of input tensors) into an output tensor. Note that the shape of the input tensor could be obtained by <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#afc1a100be4fb3aa0459b0f789384f1ea">Layer.get_tensor_shape</a>.</li>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#a720a2d4674e407d73302570c8cc5a968">output_shape(input_shape)</a>: Return the layer's output shape given the input shape (or a list of input shapes). If not implemented, default behavior is to return the input shape (or the first input shape in the list).</li>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#a31f7ca6d401883ac01dbcad31356d293">input_dimension()</a>: For single input layers. Return the expected dimension of the input shape. If not implemented, Keraflow will not check if the input dimension is correct, which could lead to errors at run time.</li>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#ad9d0871648111f88b8370b293a32561f">check_input_shape(input_shapes)</a>: For multiple-input layers. Validate if the input shapes are correct. If not implemented, default behavior will be checking if all the input shapes are the same.</li>
<li><a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#aa9a86d73c6970619f4d3049f7cef1820">pack_init_param()</a>: Optional. You should abide some <a class="el" href="md_Developer-Guide.html#serialization_mechanism">constraints</a> on your layer's <code>__init__</code> to make it serializable, else you will need to implement this function if you want to correctly serialize the layer.</li>
</ul>
<p>The following example implements a layer that take an 1D tensor, discard the first half units, and fully connects the second half of the units to the output: </p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">from</span> keraflow <span class="keyword">import</span> utils</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">from</span> keraflow utils <span class="keyword">import</span> backend <span class="keyword">as</span> B</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">class </span>HalfDense(Layer):</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="keyword">def </span>__init__(self, output_dim, init=&#39;glorot_uniform&#39;, activation=&#39;linear&#39;, **kwargs):</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        super(HalfDense, self).__init__(**kwargs)</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        self.output_dim = output_dim</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        self.init = utils.get_from_module(<span class="stringliteral">&#39;initializations&#39;</span>, init)</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        self.activation = utils.get_from_module(<span class="stringliteral">&#39;activations&#39;</span>, activation)</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="keyword">def </span>input_dimension(self):</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        <span class="keywordflow">return</span> 2  <span class="comment"># Includng batch size dimension.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="keyword">def </span>init_param(self, input_shape):</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        input_dim = input_shape[1]  <span class="comment"># The first dimension is the batch dimension. </span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        W = self.init((input_dim/2, self.output_dim))</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        self.set_trainable_params(<span class="stringliteral">&#39;W&#39;</span>, W)</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    <span class="keyword">def </span>output(self, x):</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        input_shape = self.get_tensor_shape(x)  <span class="comment"># Use get_tensor_shape to get the input shape</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        input_dim = input_shape[1]  </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        output = B.dot(x[:, input_dimension/2:], self.W)  <span class="comment"># Dot the second half of the input with W</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        <span class="keywordflow">return</span> self.activation(output)</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="keyword">def </span>output_shape(self, input_shape):</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        <span class="keywordflow">return</span> (input_shape[0], self.output_dim)  <span class="comment"># batch size does not change</span></div>
</div><!-- fragment --><h2><a class="anchor" id="layer_embedding"></a>
Layer Embedding</h2>
<p>Sometimes you might want to use operations implemented by existing layers. <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#a47aefb1205cb3e4b121c2cb992f44d76">Layer.embed</a> is a syntax sugar for this purpose. It embeds the target layer such that the its trainable parameters (along with regularizers and constraints on the parameters) are treated as the host layer's parameters and are updated during the training process. You could use it in a customized layer's <code>output()</code> function like: </p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">def </span>output(self, x):</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    dx = self.embed(Dense(64, regularizers=[<span class="stringliteral">&#39;l1&#39;</span>]))(x)</div>
</div><!-- fragment --><p>In fact, <a class="el" href="classkeraflow_1_1layers_1_1base_1_1SequentialLayer.html">SequentialLayer</a> is implemented using this functions: </p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">class </span>SequentialLayer(Layer):</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    <span class="keyword">def </span>__init__(self, layers=[], **kwargs):</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        super(SequentialLayer, self).__init__(**kwargs)</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        self.layers = list(layers)</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="keyword">def </span>output(self, input_tensors):</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        output_tensor = input_tensors</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        <span class="keywordflow">for</span> layer <span class="keywordflow">in</span> self.layers:</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            output_tensor = self.embed(layer)(output_tensor)</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        <span class="keywordflow">return</span> output_tensor</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="keyword">def </span>output_shape(self, input_shapes):</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        res = input_shapes</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        <span class="keywordflow">for</span> layer <span class="keywordflow">in</span> self.layers:</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;            res = layer.output_shape(res)</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        <span class="keywordflow">return</span> res</div>
</div><!-- fragment --><p> We do not need to implement <code>init_param</code> function since <code>SequentialLayer</code> itself has no parameters.</p>
<p>You could also check the implementation of the <code>output</code> function of <a class="el" href="classkeraflow_1_1layers_1_1convolution_1_1Convolution1D.html">Convolution1D</a>, <a class="el" href="classkeraflow_1_1layers_1_1convolution_1_1Convolution2D.html">Convolution2D</a> and <a class="el" href="classkeraflow_1_1layers_1_1wrappers_1_1TimeDistributed.html">TimeDistributed</a> for example on how to use <code>embed</code>.</p>
<h1><a class="anchor" id="keraflow_mechanism"></a>
Keraflow mechanism</h1>
<h2><a class="anchor" id="tensor_linkage_mechanism"></a>
Tensor Linkage Mechanism</h2>
<p>The core of tensors linkage is <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#a2c66dc43b0a5eade35c7fc47e267b22b">Layer.__call__</a>. It accepts a <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Kensor.html">Kensor</a> (or as list of Kensors) and return a single <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Kensor.html">Kensor</a>. Each kensor embeds a tensor (a theano/tensorflow variable) and the major function of <code>__call__</code> is to define the relation between the input tensor(s) and the output tensor.</p>
<p>Another function of <code>__call__</code> is to maintain a global list of trainable <code>parameters</code>, <code>regularizers</code>, <code>constraints</code> and parameter <code>updates</code>, which will be latter used in <a class="el" href="classkeraflow_1_1models_1_1Model.html#a1693672d05741f848e1a30f5c58bbbcd">Model.compile</a> to determine the total <code>loss</code> and what to update during the training process. The task is done by adding current layer's parameters' info into the list carried by the input kensor and then assign the updated list to the output kensor. The model then fetch the list from the output kensor(s).</p>
<p>One final task of <code>__call__</code> is to ensure the model could be reconstructed, this is done by keeping a global list of <code>path</code> in the form <code>[path1, path2...]</code>, where <code>path1</code>, <code>path2</code>... are in the form of <code>[input kensor's name, layer's name, output kensor's name]</code>. When reconstructing the model, we could then find kensors and layers by name and decide to feed which kensor to which layer. The <code>path</code> is again passed from kensor to kensor and the model collects the final <code>path</code> from the output kensors.</p>
<h2><a class="anchor" id="serialization_mechanism"></a>
Serialization Mechanism</h2>
<p>Keraflow serialize an object (model, layer, regularizer...) by memorizing the object's class, and the value of the arguments listed in its <code>__init__</code>. For un-serialization, we simply call <code>__init__</code> of the memorized class with the memorized argument values.</p>
<p>Note that the serialization process is a recursive process, i.e. <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#a9f5e61993a3dc07976bd217655305d99">serialize</a>(<code>obj</code>) calls <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#aeacd70781fca5ff07c2f381c687a8161">pack_init_params</a>(<code>obj</code>), which in term calls <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#a9f5e61993a3dc07976bd217655305d99">serialize</a> on all <code>__init__</code> arguments of <code>obj</code>.</p>
<p>Due to such implementation, the constraints for an object to be serializable are:</p>
<ol type="1">
<li>The arguments listed in the object's <code>__init__</code> should be in the object's <code>__dict__</code> when calling <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#a9f5e61993a3dc07976bd217655305d99">serialize</a>(<code>obj</code>)</li>
<li>The arguments listed in the object's <code>__init__</code> should be stored <b>as is</b> passed to the layer's <code>__init__</code>, i.e. you should not do the following <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacekeraflow_1_1utils.html">keraflow.utils</a> <span class="keyword">import</span> serizlize, unserialize</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">class </span>MyLayer(Layer):</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="keyword">def </span>__init__(self, output_dim, additional_dim, **kwargs)</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        self.output_dim = output_dim + additional_dim</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;        self.additional_dim = additional_dim</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        ...</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;layer = MyLayer(1, 2)</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;layer_config = serialize(d1)</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;reconstructed = unserialize(layer_config)</div>
</div><!-- fragment --> The reason is that when calling <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#a1d040393a6dfdbc45815989c5f6fd4c2">unserialize</a>(<code>layer_config</code>), <code>output_dim</code> is equal to 3 and <code>additional_dim</code> equals to 2 . This will make <code>reconstructed</code> have <code>output_dim</code> equal to 5, which makes <code>reconstructed</code> and <code>layer</code> behave differently.</li>
</ol>
<p>If you really need to modify the value of the arguments, you should implement the <code>pack_init_param</code> as the following: </p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">class </span>MyLayer(Layer):</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    <span class="keyword">def </span>__init__(self, output_dim, additional_dim)</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        self.output_dim = output_dim + additional_dim</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        self.additional_dim = additional_dim</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;        ...</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="keyword">def </span>pack_init_param(self):</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        params = super(MyLayer, self).pack_init_param(self)</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        params[<span class="stringliteral">&#39;output_dim&#39;</span>] = params[<span class="stringliteral">&#39;output_dim&#39;</span>]-self.additional_dim</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        <span class="keywordflow">return</span> params</div>
</div><!-- fragment --><p> Since <a class="el" href="namespacekeraflow_1_1utils_1_1generic__utils.html#a9f5e61993a3dc07976bd217655305d99">serialize</a> check if an object implements <code>pack_init_param</code> before the default behavior of saving the arguments <b>as is</b>, the <code>pack_init_param</code> of <code>MyLayer</code> get called and reset <code>output_dim</code> to 1 (as passed during initialization).</p>
<p>Note that when implementing <code>pack_init_param</code> for a new layer, we should first call <a class="el" href="classkeraflow_1_1layers_1_1base_1_1Layer.html#aa9a86d73c6970619f4d3049f7cef1820">Layer.pack_init_param</a> (line 8), which packs not only arguments listed in <code>MyLayer.__init__</code> but also <code>Layer.__init__</code> (including regularizers, constraints). Otherwise, you should then handle those things your self. For details, please check the code. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Sep 5 2016 16:51:26 for Keraflow by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
